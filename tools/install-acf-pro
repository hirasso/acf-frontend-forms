#!/usr/bin/env php
<?php

/**
 * Fetches the latest release asset from GitHub, downloads,
 * and extracts it into a target directory. PHP 8.3+
 *
 * Requires: guzzlehttp/guzzle
 *
 * Usage:
 *   php install-acf-pro.php <target-directory>
 */

declare(strict_types=1);

require_once dirname(__DIR__) . '/vendor/autoload.php';

use GuzzleHttp\Client;

/**
 * Simple logger with prefix
 */
class Logger
{
    public function __construct(private readonly string $prefix) {}

    public function log(string ...$args): void
    {
        echo $this->prefix . ' ' . implode(' ', $args) . PHP_EOL;
    }

    public function error(string ...$args): void
    {
        fwrite(STDERR, $this->prefix . ' ' . implode(' ', $args) . PHP_EOL);
    }
}

/**
 * Empties a directory by removing all its contents while keeping the directory itself.
 */
function emptyDirectory(string $dirPath): void
{
    if (!is_dir($dirPath)) {
        return;
    }

    $entries = scandir($dirPath);
    foreach ($entries as $entry) {
        if ($entry === '.' || $entry === '..') {
            continue;
        }

        $path = $dirPath . DIRECTORY_SEPARATOR . $entry;

        if (is_dir($path)) {
            deleteDirectory($path);
        } else {
            unlink($path);
        }
    }
}

/**
 * Recursively deletes a directory and all its contents.
 */
function deleteDirectory(string $dir): void
{
    if (!is_dir($dir)) {
        return;
    }

    $entries = scandir($dir);
    foreach ($entries as $entry) {
        if ($entry === '.' || $entry === '..') {
            continue;
        }

        $path = $dir . DIRECTORY_SEPARATOR . $entry;

        if (is_dir($path)) {
            deleteDirectory($path);
        } else {
            unlink($path);
        }
    }

    rmdir($dir);
}

/**
 * Fetches the download URL of the latest GitHub release asset matching a pattern.
 *
 * @return string|null The browser_download_url of the matching asset, or null if none found
 */
function getLatestReleaseAsset(Client $client, string $owner, string $repo, string $pattern): ?string
{
    $url = "https://api.github.com/repos/$owner/$repo/releases/latest";

    $response = $client->get($url, [
        'headers' => [
            'Accept' => 'application/vnd.github+json',
            'User-Agent' => 'PHP'
        ]
    ]);

    $release = json_decode($response->getBody()->getContents(), true);

    if (!isset($release['assets']) || count($release['assets']) === 0) {
        return null;
    }

    foreach ($release['assets'] as $asset) {
        if (preg_match($pattern, $asset['name'])) {
            return $asset['browser_download_url'] ?? null;
        }
    }

    return null;
}

/**
 * Downloads a file from a URL and writes it to a target path.
 */
function downloadFile(Client $client, string $url, string $destPath): void
{
    $client->get($url, [
        'sink' => $destPath
    ]);
}

/**
 * Extracts a zip file into a target directory.
 */
function extractZip(string $zipPath, string $targetDir): void
{
    if (!is_dir($targetDir)) {
        mkdir($targetDir, 0755, true);
    }

    $zip = new ZipArchive();

    if ($zip->open($zipPath) !== true) {
        throw new RuntimeException("Failed to open zip file: $zipPath");
    }

    if (!$zip->extractTo($targetDir)) {
        $zip->close();
        throw new RuntimeException("Failed to extract zip to: $targetDir");
    }

    $zip->close();
}

// Main execution
try {
    $logger = new Logger('[install-acf-pro]');
    $client = new Client();

    $targetDir = $argv[1] ?? null;

    if (!$targetDir) {
        $logger->error("Error: You must provide a target directory.");
        exit(1);
    }

    $url = getLatestReleaseAsset(
        $client,
        'pronamic',
        'advanced-custom-fields-pro',
        '/advanced-custom-fields-pro.*\.zip$/'
    );

    if (!$url) {
        $logger->error("No matching asset found.");
        exit(1);
    }

    $zipFile = $targetDir . DIRECTORY_SEPARATOR . 'acf-pro.zip';
    $acfProDir = $targetDir . DIRECTORY_SEPARATOR . 'advanced-custom-fields-pro';

    // Download the zip
    $logger->log("Downloading:", $url);
    downloadFile($client, $url, $zipFile);

    // Empty existing installation if present
    if (is_dir($acfProDir)) {
        $logger->log("Emptying existing installation:", $acfProDir);
        emptyDirectory($acfProDir);
    }

    // Extract the zip
    $logger->log("Extracting to:", $targetDir);
    extractZip($zipFile, $targetDir);

    // Remove zip after extraction
    unlink($zipFile);

    $logger->log("Done!");
} catch (Throwable $e) {
    $logger = new Logger('[install-acf-pro]');
    $logger->error("Error:", $e->getMessage());
    exit(1);
}
